<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<title>A√ßa√≠ da familia ‚Äî Loja + Freteiro (Prot√≥tipo)</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0f1224; --card:#161a34; --muted:#9fb0ff; --text:#eaf0ff; --accent:#7c5cff; --accent2:#34d399; --danger:#ff5c8a; --warn:#fbbf24;
  --shadow:0 10px 30px rgba(0,0,0,.35); --line:rgba(255,255,255,.08);
}
*{box-sizing:border-box}
html,body{margin:0;background:radial-gradient(1200px 800px at 80% -10%,#2a2f64 0,#0f1224 60%);color:var(--text);font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
a{color:inherit}
button{cursor:pointer;border:0;border-radius:12px;padding:12px 16px;font-weight:700}
.container{max-width:1100px;margin:auto;padding:18px}
.header{
  position:sticky;top:0;z-index:20;background:linear-gradient(180deg,rgba(15,18,36,.95),rgba(15,18,36,.6));
  backdrop-filter:saturate(130%) blur(10px);border-bottom:1px solid var(--line)
}
.brand{display:flex;align-items:center;gap:12px}
.brand .logo{
  width:44px;height:44px;border-radius:12px;background:
  conic-gradient(from 210deg,#7c5cff,#bb86fc,#7c5cff);
  box-shadow:0 6px 20px rgba(124,92,255,.4)
}
.brand h1{font-size:18px;margin:0}
.top-actions{display:flex;gap:10px;align-items:center}
.badge{font-size:12px;background:rgba(255,255,255,.08);padding:6px 10px;border-radius:999px;border:1px solid var(--line)}
.grid{display:grid;gap:16px}
.cards{grid-template-columns:repeat(auto-fill,minmax(230px,1fr))}
.card{
  background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));
  border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);overflow:hidden
}
.card .media{height:140px;display:flex;align-items:center;justify-content:center;font-size:54px}
.card .body{padding:14px}
.price{color:var(--muted);font-weight:700}
.btn-primary{background:linear-gradient(90deg,var(--accent),#9b7bff);color:white;box-shadow:0 8px 20px rgba(124,92,255,.35)}
.btn-ghost{background:rgba(255,255,255,.06);color:var(--text);border:1px solid var(--line)}
.btn-success{background:linear-gradient(90deg,var(--accent2),#00c39a);color:#04140e}
.btn-danger{background:linear-gradient(90deg,var(--danger),#ff7aa6);color:#2a0712}
.btn-warn{background:linear-gradient(90deg,var(--warn),#ffd166);color:#2b1600}
.section{display:none}
.section.active{display:block}
.nav{
  display:flex;gap:8px;flex-wrap:wrap;margin-top:10px
}
.kbd{font:600 12px/1 Poppins,monospace;background:#0b0e1c;border:1px solid var(--line);padding:4px 8px;border-radius:8px;color:#b9c5ff}

/* cart mini */
.cart-bar{
  position:fixed;left:0;right:0;bottom:0;background:rgba(15,18,36,.92);border-top:1px solid var(--line);
  display:flex;justify-content:space-between;align-items:center;padding:12px 16px;backdrop-filter:blur(8px)
}
.cart-bar .total{font-size:14px;color:#c7d2fe}
.cart-bar .go{padding:10px 14px;border-radius:10px}

/* forms */
.field{display:flex;flex-direction:column;gap:6px;margin-bottom:12px}
.input,select,textarea{
  background:rgba(255,255,255,.06);border:1px solid var(--line);border-radius:12px;color:var(--text);
  padding:12px 14px;outline:none
}
.input::placeholder{color:#99a3d6}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.table{width:100%;border-collapse:collapse;border:1px solid var(--line);border-radius:12px;overflow:hidden}
.table th,.table td{border-bottom:1px solid var(--line);padding:10px;text-align:left}
.table th{color:#cbd5ff;font-weight:700;background:rgba(255,255,255,.04)}

/* map */
.map{
  height:300px;border-radius:16px;border:1px solid var(--line);
  background:
    radial-gradient(circle at 20% 30%,rgba(124,92,255,.08),transparent 40%),
    radial-gradient(circle at 80% 70%,rgba(52,211,153,.08),transparent 40%),
    linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));
  position:relative;overflow:hidden
}
.map .grid{
  position:absolute;inset:0;background-image:
  linear-gradient(to right, rgba(255,255,255,.05) 1px, transparent 1px),
  linear-gradient(to bottom, rgba(255,255,255,.05) 1px, transparent 1px);
  background-size:40px 40px;pointer-events:none
}
.marker{position:absolute;width:18px;height:18px;border-radius:999px;background:#34d399;border:3px solid #0f1224;box-shadow:0 0 0 3px rgba(52,211,153,.35)}
.marker.fre{background:#ff6da1;box-shadow:0 0 0 3px rgba(255,109,161,.35)}
.legend{position:absolute;right:8px;top:8px;background:rgba(0,0,0,.35);padding:8px 10px;border-radius:10px;border:1px solid var(--line);font-size:12px}
.status-pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.05);font-size:12px}

/* tabs */
.tabs{display:flex;gap:10px;margin:10px 0}
.tab{padding:10px 12px;border-radius:10px;background:rgba(255,255,255,.06);border:1px solid var(--line)}
.tab.active{background:linear-gradient(90deg,rgba(124,92,255,.25),rgba(124,92,255,.08));border-color:#7c5cff}

/* toast */
.toast{position:fixed;right:16px;bottom:76px;background:#11152c;color:#eaf0ff;border:1px solid var(--line);border-radius:12px;padding:12px 14px;box-shadow:var(--shadow);opacity:0;transform:translateY(10px);transition:.25s;z-index:50}
.toast.show{opacity:1;transform:translateY(0)}

/* helper */
.hr{height:1px;background:var(--line);margin:14px 0}
.small{font-size:12px;color:#b8c1ff}
.center{display:flex;align-items:center;justify-content:center}
.hidden{display:none}
</style>
</head>
<body>

<!-- HEADER -->
<header class="header">
  <div class="container" style="display:flex;justify-content:space-between;align-items:center;">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1>A√ßa√≠ da familia <span class="badge">Prot√≥tipo</span></h1>
        <div class="small">Loja + Freteiro unificados</div>
      </div>
    </div>
    <div class="top-actions">
      <button class="btn-ghost" onclick="nav('home')">In√≠cio</button>
      <button class="btn-ghost" onclick="nav('catalogo')">Card√°pio</button>
      <button class="btn-ghost" onclick="nav('pedido')">Meu Pedido</button>
      <button class="btn-primary" onclick="nav('rastreamento')">Rastrear</button>
      <button class="btn-success" onclick="nav('freteiro')">√Årea do Freteiro</button>
    </div>
  </div>
</header>

<!-- MAIN -->
<main class="container">

  <!-- HOME -->
  <section id="home" class="section active">
    <div class="card" style="display:grid;grid-template-columns:1.3fr 1fr;gap:18px;align-items:center;padding:16px">
      <div>
        <h2 style="margin:8px 0 6px 0">Sua loja de <span style="color:#bb86fc">a√ßa√≠</span> com entrega inteligente</h2>
        <p style="color:#cbd5ff">Monte seu copo, acompanhe a produ√ß√£o e veja a localiza√ß√£o do freteiro em tempo real (simulado). Tudo num s√≥ app.</p>
        <div class="nav">
          <button class="btn-primary" onclick="nav('catalogo')">Ver Card√°pio</button>
          <button class="btn-success" onclick="nav('pedido')">Montar A√ßa√≠</button>
          <button class="btn-ghost" onclick="nav('rastreamento')">Rastrear Pedido</button>
        </div>
        <div class="hr"></div>
        <div class="status-pill"><span style="width:10px;height:10px;background:#34d399;border-radius:999px"></span> Entregas ativas: <b id="entregasAtivas">0</b></div>
      </div>
      <div class="map">
        <div class="grid"></div>
        <div class="legend">Mapa demonstrativo</div>
        <div class="marker" id="mkCliente" style="left:60%;top:65%"></div>
        <div class="marker fre" id="mkFreteiro" style="left:20%;top:20%"></div>
      </div>
    </div>

    <div class="hr"></div>

    <h3>Destaques da Casa</h3>
    <div class="grid cards" id="cardsDestaque"></div>
  </section>

  <!-- CATALOGO -->
  <section id="catalogo" class="section">
    <h2>Card√°pio</h2>
    <div class="tabs">
      <div class="tab active" data-tab="copos" onclick="tab(this)">Copos</div>
      <div class="tab" data-tab="tigelas" onclick="tab(this)">Tigelas</div>
      <div class="tab" data-tab="adicionais" onclick="tab(this)">Adicionais</div>
      <div class="tab" data-tab="bebidas" onclick="tab(this)">Bebidas</div>
    </div>
    <div class="grid cards" id="listaProdutos"></div>
  </section>

  <!-- PEDIDO / MONTAGEM -->
  <section id="pedido" class="section">
    <h2>Monte seu A√ßa√≠</h2>
    <div class="grid" style="grid-template-columns:1fr 1fr">
      <div class="card">
        <div class="body">
          <h3>Escolhas</h3>
          <div class="field">
            <label>Tamanho</label>
            <select id="selTamanho" class="input" onchange="recalcular()">
              <option value="P">P ‚Äî 300ml</option>
              <option value="M" selected>M ‚Äî 500ml</option>
              <option value="G">G ‚Äî 700ml</option>
            </select>
          </div>
          <div class="field">
            <label>Base</label>
            <select id="selBase" class="input" onchange="recalcular()">
              <option value="acai" selected>A√ßa√≠ Tradicional</option>
              <option value="acaiZero">A√ßa√≠ Zero A√ß√∫car</option>
              <option value="cupua√ßu">Cupua√ßu</option>
            </select>
          </div>
          <div class="field">
            <label>Adicionais (at√© 5)</label>
            <div id="chkAdicionais" class="grid" style="grid-template-columns:repeat(2,1fr)"></div>
          </div>
          <div class="field">
            <label>Observa√ß√µes</label>
            <textarea id="obs" rows="3" class="input" placeholder="Ex: pouco xarope, sem granola..."></textarea>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="body">
          <h3>Resumo do Pedido</h3>
          <div id="resumo"></div>
          <div class="hr"></div>
          <div class="row">
            <div>
              <div class="small">Subtotal</div>
              <div class="price" id="subtotal">R$ 0,00</div>
            </div>
            <div>
              <div class="small">Entrega (sim.)</div>
              <div class="price" id="frete">R$ 0,00</div>
            </div>
          </div>
          <div class="hr"></div>
          <h2 style="margin:0">Total: <span id="total">R$ 0,00</span></h2>
          <div class="nav">
            <button class="btn-primary" onclick="adicionarAoCarrinho()">Adicionar ao Carrinho</button>
            <button class="btn-success" onclick="nav('checkout')">Ir para Checkout</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- CHECKOUT -->
  <section id="checkout" class="section">
    <h2>Checkout</h2>
    <div class="grid" style="grid-template-columns:1fr 1fr">
      <div class="card"><div class="body">
        <h3>Endere√ßo de Entrega</h3>
        <div class="field"><label>Nome</label><input id="cliNome" class="input" placeholder="Seu nome"></div>
        <div class="field"><label>WhatsApp</label><input id="cliWhats" class="input" placeholder="(51) 9 9999-9999"></div>
        <div class="field"><label>Endere√ßo</label><input id="cliEndereco" class="input" placeholder="Rua, n√∫mero, bairro"></div>
        <div class="row">
          <div class="field"><label>Cidade</label><input id="cliCidade" class="input" value="Porto Alegre"></div>
          <div class="field"><label>Refer√™ncia</label><input id="cliRef" class="input" placeholder="Port√£o azul, bloco B..."></div>
        </div>
      </div></div>
      <div class="card"><div class="body">
        <h3>Pagamento</h3>
        <div class="field">
          <label>Forma</label>
          <select id="cliPag" class="input">
            <option value="pix" selected>Pix</option>
            <option value="cartao">Cart√£o (maquininha)</option>
            <option value="dinheiro">Dinheiro</option>
          </select>
        </div>
        <table class="table" id="tabelaCarrinho"></table>
        <div class="hr"></div>
        <div class="row">
          <div><div class="small">Itens</div><div class="price" id="ckIt">R$ 0,00</div></div>
          <div><div class="small">Entrega</div><div class="price" id="ckFre">R$ 0,00</div></div>
        </div>
        <div class="hr"></div>
        <h2 style="margin:0 0 10px 0">Total: <span id="ckTot">R$ 0,00</span></h2>
        <button class="btn-success" onclick="finalizarPedido()">Finalizar & Chamar Frete</button>
        <div class="small" style="margin-top:8px">* Pagamento simulado para demonstra√ß√£o.</div>
      </div></div>
    </div>
  </section>

  <!-- RASTREAMENTO -->
  <section id="rastreamento" class="section">
    <h2>Rastreamento do Pedido</h2>
    <div class="card"><div class="body">
      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
        <div class="status-pill"><span id="stBadge" style="width:10px;height:10px;border-radius:999px;background:#9ca3af"></span> <b id="statusPedido">Sem pedido</b></div>
        <div class="small">Pedido #<span id="numPedido">‚Äî</span></div>
      </div>
      <div class="hr"></div>
      <div class="map" id="mapaTrack">
        <div class="grid"></div>
        <div class="legend">Cliente (verde) ‚Ä¢ Freteiro (rosa)</div>
        <div class="marker" id="trkCliente" style="left:60%;top:70%"></div>
        <div class="marker fre" id="trkFreteiro" style="left:15%;top:18%"></div>
      </div>
      <div class="nav" style="margin-top:10px">
        <button class="btn-ghost" onclick="simularPassoFrete()">Simular movimento</button>
        <button class="btn-warn" onclick="simularStatus()">Simular status</button>
      </div>
      <div class="hr"></div>
      <div id="detPedido" class="small"></div>
    </div></div>
  </section>

  <!-- FRETEIRO -->
  <section id="freteiro" class="section">
    <h2>√Årea do Freteiro</h2>
    <div class="grid" style="grid-template-columns:1fr 1fr">
      <div class="card"><div class="body">
        <h3>Login</h3>
        <div class="field"><label>C√≥digo</label><input id="freCode" class="input" placeholder="FRETE123 (demo)"></div>
        <div class="nav"><button class="btn-primary" onclick="loginFreteiro()">Entrar</button><div id="freOk" class="small"></div></div>
      </div></div>
      <div class="card"><div class="body">
        <h3>Corridas</h3>
        <table class="table" id="tbCorridas"></table>
        <div class="nav">
          <button class="btn-success" onclick="aceitarSelecionada()">Aceitar</button>
          <button class="btn-warn" onclick="iniciarRota()">Iniciar rota</button>
          <button class="btn-primary" onclick="simularPassoFrete()">Mover</button>
          <button class="btn-danger" onclick="finalizarEntrega()">Finalizar</button>
        </div>
        <div class="small">Selecione um pedido na tabela para agir.</div>
      </div></div>
    </div>
  </section>

</main>

<!-- CART MINI -->
<div class="cart-bar" id="cartBar" style="display:none">
  <div class="total"><b id="cartQtd">0</b> item(ns) ‚Ä¢ <b id="cartTot">R$ 0,00</b></div>
  <div>
    <button class="btn-ghost go" onclick="nav('pedido')">Montar</button>
    <button class="btn-primary go" onclick="nav('checkout')">Fechar pedido</button>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
/* ========== DADOS DEMO ========== */
const produtos = [
  // Copos
  {id:'cP', nome:'Copo P 300ml', cat:'copos', emoji:'ü•§', preco:14.9, desc:'Para quem quer leveza'},
  {id:'cM', nome:'Copo M 500ml', cat:'copos', emoji:'ü•§', preco:19.9, desc:'Nosso campe√£o de vendas'},
  {id:'cG', nome:'Copo G 700ml', cat:'copos', emoji:'ü•§', preco:24.9, desc:'Para os fortes!'},
  // Tigelas
  {id:'tM', nome:'Tigela M√©dia', cat:'tigelas', emoji:'üçß', preco:26.9, desc:'Granola + banana + mel'},
  {id:'tG', nome:'Tigela Grande', cat:'tigelas', emoji:'üçß', preco:31.9, desc:'Refor√ßada para matar a fome'},
  // Adicionais
  {id:'aGran', nome:'Granola', cat:'adicionais', emoji:'ü•£', preco:3.0, desc:'Croc√¢ncia'},
  {id:'aMor',  nome:'Morangos', cat:'adicionais', emoji:'üçì', preco:4.5, desc:'Fresquinhos'},
  {id:'aBan',  nome:'Banana', cat:'adicionais', emoji:'üçå', preco:3.5, desc:'Docinha'},
  {id:'aLeite',nome:'Leite Cond.', cat:'adicionais', emoji:'ü•õ', preco:3.9, desc:'Aquele toque'},
  {id:'aPac',  nome:'Pa√ßoca', cat:'adicionais', emoji:'ü•ú', preco:3.9, desc:'Cl√°ssica'},
  // Bebidas
  {id:'bAgua', nome:'√Ågua 500ml', cat:'bebidas', emoji:'üíß', preco:4.0, desc:'Sem g√°s'},
  {id:'bRef',  nome:'Refrigerante', cat:'bebidas', emoji:'ü•§', preco:7.0, desc:'Lata 350ml'},
];
const adicionaisList = produtos.filter(p=>p.cat==='adicionais').map(p=>({id:p.id,nome:p.nome,preco:p.preco}));

/* ========== ESTADO ========== */
const state = {
  carrinho: JSON.parse(localStorage.getItem('carrinhoDemo')||'[]'),
  selecionado: null,
  pedidoAtual: JSON.parse(localStorage.getItem('pedidoAtualDemo')||'null'),
  freteiro: JSON.parse(localStorage.getItem('freteiroDemo')||'null'),
  corridas: JSON.parse(localStorage.getItem('corridasDemo')||'[]'),
  driverPos: {x:15,y:18}, // %
  clientPos:{x:60,y:70},  // %
  status:'Sem pedido',    // Produ√ß√£o -> A caminho -> Entregue
};

/* ========== NAV ========== */
function nav(id){
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  if(id==='catalogo') renderCatalogo('copos');
  if(id==='pedido') refreshResumo();
  if(id==='checkout') renderCheckout();
  if(id==='rastreamento') refreshRastreamento();
  if(id==='freteiro') renderCorridas();
  updateCartBar();
  if(id==='home') renderDestaques();
  window.scrollTo({top:0,behavior:'smooth'});
}

/* ========== TOAST ========== */
function toast(msg, t=2200){
  const el = document.getElementById('toast');
  el.textContent = msg; el.classList.add('show');
  setTimeout(()=>el.classList.remove('show'), t);
}

/* ========== HOME ========== */
function renderDestaques(){
  const dest = [
    {emoji:'üçß',t:'A√ßa√≠ com Morango',p:24.9},
    {emoji:'üç´',t:'A√ßa√≠ + Chocolate',p:22.9},
    {emoji:'ü•ú',t:'A√ßa√≠ Pa√ßoca',p:23.9},
    {emoji:'üçå',t:'A√ßa√≠ Banana',p:21.9},
  ];
  const wrap = document.getElementById('cardsDestaque');
  wrap.innerHTML = dest.map(d=>`
    <div class="card">
      <div class="media">${d.emoji}</div>
      <div class="body">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><b>${d.t}</b><div class="small">O queridinho da casa</div></div>
          <div class="price">R$ ${d.p.toFixed(2).replace('.',',')}</div>
        </div>
        <div class="nav" style="margin-top:8px">
          <button class="btn-primary" onclick="nav('pedido')">Montar igual</button>
        </div>
      </div>
    </div>
  `).join('');
  // Entregas ativas (contador simples)
  const ativas = state.corridas.filter(c=>c.status==='A caminho').length;
  document.getElementById('entregasAtivas').textContent = ativas;
}

/* ========== CATALOGO ========== */
function tab(el){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  el.classList.add('active');
  renderCatalogo(el.dataset.tab);
}
function renderCatalogo(cat){
  const wrap = document.getElementById('listaProdutos');
  const itens = produtos.filter(p=>p.cat===cat);
  wrap.innerHTML = itens.map(p=>`
    <div class="card">
      <div class="media">${p.emoji}</div>
      <div class="body">
        <b>${p.nome}</b>
        <div class="small">${p.desc||''}</div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
          <div class="price">R$ ${p.preco.toFixed(2).replace('.',',')}</div>
          <button class="btn-primary" onclick='addProduto("${p.id}")'>Adicionar</button>
        </div>
      </div>
    </div>
  `).join('');
}

/* ========== PEDIDO (montagem) ========== */
function initAdicionais(){
  const el = document.getElementById('chkAdicionais');
  el.innerHTML = adicionaisList.map(a=>`
    <label style="display:flex;gap:10px;align-items:center">
      <input type="checkbox" value="${a.id}" onchange="recalcular()">
      ${a.nome} <span class="small">‚Äî R$ ${a.preco.toFixed(2).replace('.',',')}</span>
    </label>
  `).join('');
}
function getEscolhas(){
  const tam = document.getElementById('selTamanho').value;
  const base = document.getElementById('selBase').value;
  const ad = [...document.querySelectorAll('#chkAdicionais input:checked')].map(i=>i.value).slice(0,5);
  return {tam,base,ad,obs:document.getElementById('obs').value.trim()};
}
function precoTamanho(t){
  return t==='P'?14.9:t==='M'?19.9:24.9;
}
function precoAdicional(id){
  const a = adicionaisList.find(x=>x.id===id); return a?a.preco:0;
}
function estimarFrete(){ // simulado por dist√¢ncia "fake"
  const dx = Math.abs(state.driverPos.x - state.clientPos.x);
  const dy = Math.abs(state.driverPos.y - state.clientPos.y);
  const dist = Math.sqrt(dx*dx+dy*dy); // 0..100
  const base = 6.9; const vario = (dist/100)*8; // at√© +8
  return Math.round((base+vario)*10)/10;
}
function recalcular(){
  const esc = getEscolhas();
  const sub = precoTamanho(esc.tam) + esc.ad.reduce((s,id)=>s+precoAdicional(id),0);
  const fre = estimarFrete();
  document.getElementById('resumo').innerHTML =
    `<div class="small">Tamanho: <b>${esc.tam}</b> ‚Ä¢ Base: <b>${esc.base}</b><br>
     Adicionais: ${esc.ad.length?esc.ad.map(id=>adicionaisList.find(a=>a.id===id).nome).join(', '):'‚Äî'}<br>
     Obs: ${esc.obs||'‚Äî'}</div>`;
  document.getElementById('subtotal').textContent = brl(sub);
  document.getElementById('frete').textContent    = brl(fre);
  document.getElementById('total').textContent    = brl(sub+fre);
}
function adicionarAoCarrinho(){
  const esc = getEscolhas();
  const item = {
    id:'it'+Date.now(),
    nome:`A√ßa√≠ ${esc.tam} (${esc.base})`,
    adicionais:esc.ad,
    obs:esc.obs,
    q:1,
    preco:precoTamanho(esc.tam)+esc.ad.reduce((s,id)=>s+precoAdicional(id),0)
  };
  state.carrinho.push(item);
  persist();
  updateCartBar();
  toast('Item adicionado ao carrinho ‚úÖ');
}
function addProduto(pid){
  const p = produtos.find(x=>x.id===pid);
  state.carrinho.push({id:'it'+Date.now(),nome:p.nome,adicionais:[],obs:'',q:1,preco:p.preco});
  persist(); updateCartBar(); toast('Adicionado ao carrinho ‚úÖ');
}

/* ========== CHECKOUT ========== */
function renderCheckout(){
  const tb = document.getElementById('tabelaCarrinho');
  if(!state.carrinho.length){
    tb.innerHTML = '<tr><td class="small">Seu carrinho est√° vazio.</td></tr>';
    document.getElementById('ckIt').textContent = brl(0);
    document.getElementById('ckFre').textContent = brl(0);
    document.getElementById('ckTot').textContent = brl(0);
    return;
  }
  tb.innerHTML = `
    <tr><th>Item</th><th>Qtd</th><th>Pre√ßo</th><th>A√ß√µes</th></tr>
    ${state.carrinho.map(i=>`
      <tr>
        <td><b>${i.nome}</b><div class="small">${i.adicionais.length?i.adicionais.length+' adic.':''} ${i.obs?('‚Ä¢ '+i.obs):''}</div></td>
        <td>${i.q}</td>
        <td>${brl(i.preco*i.q)}</td>
        <td>
          <button class="btn-ghost" onclick='altQtd("${i.id}",1)'>+</button>
          <button class="btn-ghost" onclick='altQtd("${i.id}",-1)'>‚àí</button>
          <button class="btn-danger" onclick='remItem("${i.id}")'>Remover</button>
        </td>
      </tr>
    `).join('')}
  `;
  const itens = state.carrinho.reduce((s,i)=>s+i.preco*i.q,0);
  const fre = estimarFrete();
  document.getElementById('ckIt').textContent = brl(itens);
  document.getElementById('ckFre').textContent = brl(fre);
  document.getElementById('ckTot').textContent = brl(itens+fre);
}
function altQtd(id, d){
  const it = state.carrinho.find(i=>i.id===id);
  if(!it) return;
  it.q = Math.max(1, it.q + d);
  persist(); renderCheckout(); updateCartBar();
}
function remItem(id){
  state.carrinho = state.carrinho.filter(i=>i.id!==id);
  persist(); renderCheckout(); updateCartBar();
}
function finalizarPedido(){
  if(!state.carrinho.length){ toast('Carrinho vazio'); return; }
  const nome = gi('cliNome'), whats=gi('cliWhats'), end=gi('cliEndereco');
  if(!nome||!whats||!end){ toast('Preencha nome, WhatsApp e endere√ßo'); return; }
  const pedido = {
    id: 'PED'+(Math.floor(Math.random()*9000)+1000),
    cliente: {nome,whats,endereco:end,cidade:gi('cliCidade'),ref:gi('cliRef'),pag:gi('cliPag')},
    itens: JSON.parse(JSON.stringify(state.carrinho)),
    total: document.getElementById('ckTot').textContent,
    freteEstimado: estimarFrete(),
    status: 'Em produ√ß√£o',
    posCliente: {...state.clientPos},
    posFreteiro: {...state.driverPos}
  };
  state.pedidoAtual = pedido;
  state.corridas.push({id:pedido.id, cliente:pedido.cliente, total:pedido.total, status:'Dispon√≠vel', posCliente:pedido.posCliente, posFreteiro:pedido.posFreteiro});
  state.carrinho = [];
  persist();
  updateCartBar();
  renderCorridas();
  toast('Pedido criado e enviado ao freteiro üöÄ');
  nav('rastreamento');
}

/* ========== RASTREAMENTO ========== */
function refreshRastreamento(){
  const st = document.getElementById('statusPedido');
  const np = document.getElementById('numPedido');
  const det = document.getElementById('detPedido');
  const badge = document.getElementById('stBadge');

  if(!state.pedidoAtual){
    st.textContent = 'Sem pedido';
    np.textContent = '‚Äî';
    det.innerHTML = '<div class="small">Crie um pedido para rastrear.</div>';
    badge.style.background = '#9ca3af';
    return;
  }
  st.textContent = state.pedidoAtual.status;
  np.textContent = state.pedidoAtual.id;
  det.innerHTML = `
    <div><b>${state.pedidoAtual.cliente.nome}</b> ‚Äî ${state.pedidoAtual.cliente.endereco}</div>
    <div class="small">Pagamento: ${state.pedidoAtual.cliente.pag.toUpperCase()} ‚Ä¢ Total ${state.pedidoAtual.total}</div>
  `;
  badge.style.background = state.pedidoAtual.status==='A caminho' ? '#34d399' :
                           state.pedidoAtual.status==='Em produ√ß√£o' ? '#fbbf24' :
                           state.pedidoAtual.status==='Entregue' ? '#7c5cff' : '#9ca3af';

  // posi√ß√µes no mapa
  setMarker('trkCliente', state.clientPos);
  setMarker('trkFreteiro', state.driverPos);
}
function simularStatus(){
  if(!state.pedidoAtual){ toast('Crie um pedido primeiro'); return; }
  const order = state.pedidoAtual;
  if(order.status==='Em produ√ß√£o'){
    order.status='A caminho';
    // tamb√©m na corrida
    const c = state.corridas.find(x=>x.id===order.id); if(c) c.status='A caminho';
  } else if(order.status==='A caminho'){
    order.status='Entregue';
    const c = state.corridas.find(x=>x.id===order.id); if(c) c.status='Entregue';
  } else {
    order.status='Em produ√ß√£o';
    const c = state.corridas.find(x=>x.id===order.id); if(c) c.status='Dispon√≠vel';
  }
  persist(); refreshRastreamento(); renderCorridas(); renderDestaques();
}
function simularPassoFrete(){
  // move o freteiro em dire√ß√£o ao cliente (simples)
  const dx = state.clientPos.x - state.driverPos.x;
  const dy = state.clientPos.y - state.driverPos.y;
  state.driverPos.x += Math.sign(dx)*Math.min(Math.abs(dx), 3);
  state.driverPos.y += Math.sign(dy)*Math.min(Math.abs(dy), 2);
  // atualizar em pedido/corrida
  if(state.pedidoAtual) state.pedidoAtual.posFreteiro = {...state.driverPos};
  const c = state.corridas.find(x=>state.pedidoAtual && x.id===state.pedidoAtual.id);
  if(c) c.posFreteiro = {...state.driverPos};
  persist();
  setMarker('trkFreteiro', state.driverPos);
  setMarker('mkFreteiro', state.driverPos);
  // detectar chegada
  if(Math.abs(dx)<2 && Math.abs(dy)<2 && state.pedidoAtual && state.pedidoAtual.status!=='Entregue'){
    state.pedidoAtual.status='Entregue';
    const cr = state.corridas.find(x=>x.id===state.pedidoAtual.id); if(cr) cr.status='Entregue';
    persist(); refreshRastreamento(); renderCorridas(); toast('Pedido entregue üéâ');
  }
}

/* ========== FRETEIRO ========== */
function loginFreteiro(){
  const code = document.getElementById('freCode').value.trim();
  if(code==='FRETE123'){
    state.freteiro = {nome:'Parceiro 01', code};
    persist();
    document.getElementById('freOk').textContent='Logado como Parceiro 01';
    toast('Login do freteiro ok ‚úÖ');
    renderCorridas();
  } else {
    toast('C√≥digo inv√°lido');
  }
}
function renderCorridas(){
  const tb = document.getElementById('tbCorridas');
  if(!state.corridas.length){ tb.innerHTML='<tr><td class="small">Sem corridas no momento.</td></tr>'; return; }
  tb.innerHTML = `
    <tr><th>#</th><th>Cliente</th><th>Endere√ßo</th><th>Status</th><th>Total</th></tr>
    ${state.corridas.map(c=>`
      <tr onclick='selecionarCorrida("${c.id}", this)' style="cursor:pointer">
        <td>${c.id}</td>
        <td>${c.cliente?.nome||'-'}</td>
        <td class="small">${c.cliente?.endereco||'-'}</td>
        <td>${c.status}</td>
        <td>${c.total||'-'}</td>
      </tr>
    `).join('')}
  `;
}
function selecionarCorrida(id, tr){
  state.selecionado = id;
  document.querySelectorAll('#tbCorridas tr').forEach(r=>r.style.outline='');
  if(tr) tr.style.outline='2px solid #7c5cff';
}
function aceitarSelecionada(){
  if(!state.selecionado){ toast('Selecione uma corrida'); return; }
  const c = state.corridas.find(x=>x.id===state.selecionado);
  if(!c) return;
  c.status='Aceita';
  if(state.pedidoAtual && state.pedidoAtual.id===c.id) state.pedidoAtual.status='A caminho';
  persist(); renderCorridas(); refreshRastreamento(); toast('Corrida aceita üëç');
}
function iniciarRota(){
  if(!state.selecionado){ toast('Selecione uma corrida'); return; }
  const c = state.corridas.find(x=>x.id===state.selecionado);
  if(!c) return;
  c.status='A caminho';
  if(state.pedidoAtual && state.pedidoAtual.id===c.id) state.pedidoAtual.status='A caminho';
  persist(); renderCorridas(); refreshRastreamento(); toast('Rota iniciada üõµ');
}
function finalizarEntrega(){
  if(!state.selecionado){ toast('Selecione uma corrida'); return; }
  const c = state.corridas.find(x=>x.id===state.selecionado);
  if(!c) return;
  c.status='Entregue';
  if(state.pedidoAtual && state.pedidoAtual.id===c.id) state.pedidoAtual.status='Entregue';
  persist(); renderCorridas(); refreshRastreamento(); toast('Entrega finalizada ‚úÖ');
}

/* ========== UTILS ========== */
function gi(id){ return document.getElementById(id).value.trim(); }
function brl(n){ return n.toLocaleString('pt-BR',{style:'currency',currency:'BRL'}); }
function setMarker(id,pos){ const el=document.getElementById(id); if(!el) return; el.style.left=pos.x+'%'; el.style.top=pos.y+'%'; }
function persist(){
  localStorage.setItem('carrinhoDemo', JSON.stringify(state.carrinho));
  localStorage.setItem('pedidoAtualDemo', JSON.stringify(state.pedidoAtual));
  localStorage.setItem('freteiroDemo', JSON.stringify(state.freteiro));
  localStorage.setItem('corridasDemo', JSON.stringify(state.corridas));
}

/* ========== INIT ========== */
function refreshResumo(){ recalcular(); }
function updateCartBar(){
  const qtd = state.carrinho.reduce((s,i)=>s+i.q,0);
  const tot = state.carrinho.reduce((s,i)=>s+i.q*i.preco,0);
  document.getElementById('cartQtd').textContent = qtd;
  document.getElementById('cartTot').textContent = brl(tot);
  document.getElementById('cartBar').style.display = qtd? 'flex' : 'none';
}

initAdicionais();
renderDestaques();
updateCartBar();
setMarker('mkCliente', state.clientPos);
setMarker('mkFreteiro', state.driverPos);
</script>
</body>
</html>
