<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Field Control — Protótipo</title>

<!-- Leaflet (mapa sem chave) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Firebase v10 (modules) -->
<script type="module">
// ====== IMPORTS FIREBASE ======
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc, addDoc, collection, serverTimestamp, onSnapshot, query, where, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

// ====== CONFIGURE AQUI ======
const firebaseConfig = {
  apiKey: "SUA_API_KEY",
  authDomain: "SEU_AUTH_DOMAIN",
  projectId: "SEU_PROJECT_ID",
  storageBucket: "SEU_BUCKET",
  messagingSenderId: "SENDER_ID",
  appId: "APP_ID"
};
// ====== /CONFIG ======

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

// ====== STATE ======
let user = null;
let userProfile = null;
let watchId = null;
let map, marker, adminMap;
let adminMarkers = {};
let adminLayerGroup;

// ====== HELPERS ======
const $ = (sel) => document.querySelector(sel);
const show = (el) => el.style.display = "";
const hide = (el) => el.style.display = "none";
const brl = (v) => (Number(v||0)).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});

// ====== AUTH UI ======
const loginForm = $("#loginForm");
const signForm  = $("#signForm");
const linkToSign = $("#linkToSign");
const linkToLogin = $("#linkToLogin");
const authBox = $("#authBox");
const appBox = $("#app");
const adminBox = $("#admin");

// Alterna telas login/registro
linkToSign.addEventListener("click", e => { e.preventDefault(); hide(loginForm); show(signForm); });
linkToLogin.addEventListener("click", e => { e.preventDefault(); hide(signForm); show(loginForm); });

// Registrar
signForm.addEventListener("submit", async (e)=>{
  e.preventDefault();
  const name = $("#signName").value.trim();
  const email = $("#signEmail").value.trim();
  const pass = $("#signPass").value;

  try{
    const cred = await createUserWithEmailAndPassword(auth, email, pass);
    await updateProfile(cred.user, { displayName: name || email.split("@")[0] });
    // cria doc de perfil (worker por padrão)
    await setDoc(doc(db, "users", cred.user.uid), {
      name: name || cred.user.displayName || "Sem nome",
      email,
      role: "worker",
      createdAt: serverTimestamp(),
      activeTracking: false
    });
  }catch(err){
    alert("Erro ao registrar: " + err.message);
  }
});

// Login
loginForm.addEventListener("submit", async (e)=>{
  e.preventDefault();
  const email = $("#loginEmail").value.trim();
  const pass  = $("#loginPass").value;
  try{
    await signInWithEmailAndPassword(auth, email, pass);
  }catch(err){
    alert("Erro ao entrar: " + err.message);
  }
});

// Sair
$("#btnLogout").addEventListener("click", async ()=>{
  if (watchId !== null) navigator.geolocation.clearWatch(watchId);
  await signOut(auth);
});

// ====== AUTH STATE ======
onAuthStateChanged(auth, async (u)=>{
  user = u || null;
  if(!user){
    // não logado
    show(authBox);
    hide(appBox);
    hide(adminBox);
    return;
  }
  // buscar perfil
  const snap = await getDoc(doc(db, "users", user.uid));
  if(!snap.exists()){
    // cria default (worker)
    await setDoc(doc(db, "users", user.uid), {
      name: user.displayName || "Sem nome",
      email: user.email,
      role: "worker",
      createdAt: serverTimestamp(),
      activeTracking: false
    });
    userProfile = { role: "worker" };
  } else {
    userProfile = snap.data();
  }

  hide(authBox);
  if(userProfile.role === "admin"){
    hide(appBox);
    await initAdmin();
    show(adminBox);
  } else {
    await initWorker();
    show(appBox);
    hide(adminBox);
  }
});

// ====== WORKER (FUNCIONÁRIO) ======
async function initWorker(){
  $("#helloUser").textContent = userProfile?.name || user?.displayName || "Funcionário";
  initMap("#map");

  // toggle tracking
  const btn = $("#btnToggleTrack");
  const statusEl = $("#trackStatus");

  // recuperar flag activeTracking
  const usrRef = doc(db, "users", user.uid);
  const usrSnap = await getDoc(usrRef);
  const active = usrSnap.data()?.activeTracking || false;
  setTrackUI(active);

  btn.onclick = async ()=>{
    const shouldStart = btn.dataset.state !== "on";
    await updateDoc(usrRef, { activeTracking: shouldStart });
    setTrackUI(shouldStart);
    if(shouldStart){ startWatch(); } else { stopWatch(); }
  };

  if(active){ startWatch(); }
  // formularios
  setupExpenseForm();
  setupMediaForm();
}

function setTrackUI(on){
  const btn = $("#btnToggleTrack");
  const statusEl = $("#trackStatus");
  btn.dataset.state = on ? "on" : "off";
  btn.textContent = on ? "Parar Compartilhar Localização" : "Compartilhar Localização (Iniciar)";
  statusEl.textContent = on ? "Compartilhando em tempo real" : "Parado";
  statusEl.className = on ? "chip on" : "chip off";
}

function startWatch(){
  if(!navigator.geolocation){
    alert("Geolocalização não suportada neste dispositivo.");
    return;
  }
  watchId = navigator.geolocation.watchPosition(async (pos)=>{
    const { latitude, longitude } = pos.coords;
    // Firestore: locations/{uid}
    await setDoc(doc(db,"locations", user.uid), {
      uid: user.uid,
      name: userProfile?.name || user?.displayName || "Funcionário",
      lat: latitude,
      lng: longitude,
      updatedAt: serverTimestamp()
    }, { merge: true });

    // UI marker
    updateMarker(latitude, longitude, map, (m)=> marker = m);
  }, (err)=>{
    console.warn(err);
    alert("Erro de localização: " + err.message);
  }, { enableHighAccuracy:true, maximumAge:3000, timeout:15000 });
}

function stopWatch(){
  if(watchId !== null){ navigator.geolocation.clearWatch(watchId); watchId = null; }
}

// Map genérico
function initMap(selector){
  const el = document.querySelector(selector);
  if(!el) return;
  const defaultPos = [-30.0346, -51.2177]; // Porto Alegre
  const m = L.map(el).setView(defaultPos, 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    maxZoom: 19, attribution: '&copy; OpenStreetMap'
  }).addTo(m);
  if(selector==="#map"){ map = m; }
  else { adminMap = m; }
}

function updateMarker(lat,lng, inMap, assign){
  if(!inMap) return;
  const mk = assign === undefined ? null : (assign === null ? null : undefined);
  if(assign && typeof assign === "function"){
    // único marcador (worker)
    if(marker){ inMap.removeLayer(marker); }
    assign(L.marker([lat,lng]).addTo(inMap));
    inMap.setView([lat,lng], 15);
  }
}

// Form despesa (passagem)
function setupExpenseForm(){
  const form = $("#expenseForm");
  form.addEventListener("submit", async (e)=>{
    e.preventDefault();
    const type = $("#expenseType").value;
    const amount = Number($("#expenseAmount").value);
    const note = $("#expenseNote").value.trim();
    const file = $("#expenseFile").files[0];

    if(!amount || amount<=0){ alert("Informe um valor válido."); return; }

    let fileURL = null;
    if(file){
      const ext = file.name.split(".").pop();
      const r = ref(storage, `expenses/${user.uid}/${Date.now()}.${ext}`);
      await uploadBytes(r, file);
      fileURL = await getDownloadURL(r);
    }

    await addDoc(collection(db,"expenses"), {
      uid: user.uid,
      userName: userProfile?.name || user?.displayName || "Funcionário",
      type, amount, note,
      fileURL: fileURL || null,
      status: "pending",
      createdAt: serverTimestamp()
    });

    form.reset();
    alert("Despesa enviada para aprovação.");
  });
}

// Form mídia (foto/vídeo do serviço)
function setupMediaForm(){
  const form = $("#mediaForm");
  form.addEventListener("submit", async (e)=>{
    e.preventDefault();
    const desc = $("#mediaDesc").value.trim();
    const file = $("#mediaFile").files[0];
    if(!file){ alert("Selecione uma mídia."); return; }

    const ext = file.name.split(".").pop();
    const r = ref(storage, `work_media/${user.uid}/${Date.now()}.${ext}`);
    await uploadBytes(r, file);
    const url = await getDownloadURL(r);

    await addDoc(collection(db,"work_media"), {
      uid: user.uid,
      userName: userProfile?.name || user?.displayName || "Funcionário",
      desc, url,
      mime: file.type,
      createdAt: serverTimestamp()
    });

    form.reset();
    alert("Mídia enviada.");
  });
}

// ====== ADMIN ======
async function initAdmin(){
  $("#helloAdmin").textContent = userProfile?.name || user?.displayName || "Admin";
  initMap("#adminMap");
  adminLayerGroup = L.layerGroup().addTo(adminMap);

  // Localizações ao vivo
  onSnapshot(collection(db,"locations"), (snap)=>{
    // limpar camadas
    adminLayerGroup.clearLayers();
    adminMarkers = {};
    snap.forEach(docu=>{
      const d = docu.data();
      if(!d.lat || !d.lng) return;
      const mk = L.marker([d.lat, d.lng]).bindPopup(`<b>${d.name||d.uid}</b><br/>Atualizado agora`);
      mk.addTo(adminLayerGroup);
      adminMarkers[d.uid] = mk;
    });
  });

  // Despesas pendentes
  const qExp = query(collection(db,"expenses"), where("status","==","pending"), orderBy("createdAt","desc"));
  onSnapshot(qExp, (snap)=>{
    const tbody = $("#tbodyExpenses");
    tbody.innerHTML = "";
    let total = 0;
    snap.forEach(d=>{
      const x = d.data();
      total += Number(x.amount||0);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${x.userName||x.uid}</td>
        <td>${x.type}</td>
        <td>${brl(x.amount)}</td>
        <td>${x.note||"-"}</td>
        <td>${x.fileURL?`<a href="${x.fileURL}" target="_blank">Comprovante</a>`:"-"}</td>
        <td class="actions">
           <button data-id="${d.id}" data-act="approve">Aprovar</button>
           <button data-id="${d.id}" data-act="reject" class="danger">Reprovar</button>
        </td>`;
      tbody.appendChild(tr);
    });
    $("#pendingSum").textContent = brl(total);

    // ações
    tbody.querySelectorAll("button").forEach(btn=>{
      btn.onclick = async ()=>{
        const id = btn.dataset.id;
        const act = btn.dataset.act;
        await updateDoc(doc(db,"expenses", id), { status: act==="approve"?"approved":"rejected" });
      };
    });
  });

  // Feed de mídias
  const qMed = query(collection(db,"work_media"), orderBy("createdAt","desc"), limit(12));
  onSnapshot(qMed, (snap)=>{
    const grid = $("#mediaGrid");
    grid.innerHTML = "";
    snap.forEach(d=>{
      const x = d.data();
      const isImg = (x.mime||"").startsWith("image/");
      const card = document.createElement("div");
      card.className = "mediaCard";
      card.innerHTML = `
        <div class="media">
          ${isImg ? `<img src="${x.url}" alt="media"/>` : `<video src="${x.url}" controls></video>`}
        </div>
        <div class="meta">
          <div><b>${x.userName||x.uid}</b></div>
          <small>${x.desc||""}</small>
        </div>`;
      grid.appendChild(card);
    });
  });
}
</script>

<style>
:root{
  --bg:#0e1116; --panel:#161a22; --soft:#232a36; --txt:#e6edf3; --muted:#9da9bb;
  --brand:#7c9cff; --ok:#2ecc71; --warn:#f1c40f; --danger:#ff6b6b; --chip:#2b3342;
  --shadow: 0 10px 28px rgba(0,0,0,.35);
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--txt);font:500 16px/1.5 Inter,system-ui,Segoe UI,Roboto,Arial}
a{color:var(--brand)}
.container{max-width:1100px;margin:0 auto;padding:24px}
.card{background:var(--panel);border:1px solid #222a; border-radius:14px; box-shadow:var(--shadow)}
.header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:16px}
h1{font-size:22px;margin:0}
.grid{display:grid;gap:16px}
@media(min-width:900px){ .grid-2{grid-template-columns:1.1fr .9fr}}
.btn{appearance:none;border:0;border-radius:10px;padding:10px 14px;background:var(--brand);color:#0b0e14;font-weight:700;cursor:pointer}
.btn.secondary{background:var(--soft);color:var(--txt)}
.btn.danger{background:var(--danger);color:#fff}
input,select,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #2b3342;background:#0f131b;color:var(--txt);outline:none}
label{font-size:13px;color:var(--muted)}
.row{display:grid;grid-template-columns:1fr 1fr; gap:12px}
.sep{height:1px;background:#2b3342;margin:14px 0}
.center{text-align:center}
small.muted{color:var(--muted)}
#map,#adminMap{width:100%;height:320px;border-radius:12px;border:1px solid #2b3342}
.chip{display:inline-block;padding:6px 10px;border-radius:999px;background:var(--chip);color:#fff;font-size:12px}
.chip.on{background:linear-gradient(90deg,#00c853,#43a047)}
.chip.off{background:linear-gradient(90deg,#8e24aa,#3949ab)}
.table{width:100%;border-collapse:collapse}
.table th,.table td{border-bottom:1px solid #2b3342;padding:10px;vertical-align:middle}
.table th{text-align:left;color:var(--muted);font-size:13px}
.actions button{margin-right:8px}
.mediaGrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr)); gap:12px}
.mediaCard{background:#0f131b;border:1px solid #263043;border-radius:12px;overflow:hidden}
.mediaCard .media{width:100%;height:130px;background:#0b0e14;display:flex;align-items:center;justify-content:center}
.mediaCard img{max-width:100%;max-height:130px;display:block}
.mediaCard video{width:100%;height:130px;object-fit:cover}
.mediaCard .meta{padding:8px 10px}
.headerBar{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,#0e1116,#0e1116ee 70%,transparent);padding:12px;border-bottom:1px solid #202534}
.brand{display:flex;align-items:center;gap:10px}
.brand b{font-size:18px}
.right{display:flex;align-items:center;gap:10px}
.note{padding:10px;border-radius:10px;background:#0f131b;border:1px dashed #2b3342;color:#c7d1e0}
</style>
</head>
<body>

<!-- ============ AUTH ============ -->
<div id="authBox" class="container">
  <div class="headerBar card">
    <div class="brand"><span class="chip">MVP</span><b>Field Control</b><small class="muted">— protótipo</small></div>
  </div>

  <div class="grid grid-2">
    <div class="card" style="padding:18px;">
      <div class="header"><h1>Entrar</h1></div>
      <form id="loginForm">
        <label>E-mail</label>
        <input id="loginEmail" type="email" placeholder="email@empresa.com" required>
        <label>Senha</label>
        <input id="loginPass" type="password" placeholder="••••••••" required>
        <div class="sep"></div>
        <button class="btn" type="submit">Entrar</button>
        <div class="sep"></div>
        <small class="muted">Não tem conta? <a href="#" id="linkToSign">Criar agora</a></small>
      </form>
    </div>

    <div class="card" style="padding:18px;">
      <div class="header"><h1>Criar conta</h1></div>
      <form id="signForm" style="display:none">
        <label>Nome</label>
        <input id="signName" type="text" placeholder="Seu nome">
        <label>E-mail</label>
        <input id="signEmail" type="email" placeholder="email@empresa.com" required>
        <label>Senha</label>
        <input id="signPass" type="password" placeholder="mín. 6 caracteres" required>
        <div class="sep"></div>
        <button class="btn" type="submit">Cadastrar</button>
        <div class="sep"></div>
        <small class="muted">Já tem conta? <a href="#" id="linkToLogin">Entrar</a></small>
      </form>
      <div class="note">
        <b>Perfis:</b> novos usuários nascem como <code>worker</code>. Para virar <code>admin</code>, edite o doc em <code>users/{uid}</code> no Firestore.
      </div>
    </div>
  </div>
</div>

<!-- ============ WORKER APP ============ -->
<div id="app" class="container" style="display:none">
  <div class="headerBar card">
    <div class="brand"><span class="chip">Funcionário</span><b id="helloUser">Olá</b></div>
    <div class="right">
      <span id="trackStatus" class="chip off">Parado</span>
      <button id="btnToggleTrack" class="btn secondary">Compartilhar Localização (Iniciar)</button>
      <button id="btnLogout" class="btn danger">Sair</button>
    </div>
  </div>

  <div class="grid grid-2">
    <div class="card" style="padding:16px;">
      <div class="header"><h1>Onde estou</h1></div>
      <div id="map"></div>
      <div class="sep"></div>
      <small class="muted">A localização é atualizada em tempo real enquanto o compartilhamento estiver ativo.</small>
    </div>

    <div class="card" style="padding:16px;">
      <div class="header"><h1>Despesa de passagem</h1></div>
      <form id="expenseForm">
        <div class="row">
          <div>
            <label>Tipo</label>
            <select id="expenseType" required>
              <option value="passagem_onibus">Passagem (Ônibus)</option>
              <option value="passagem_metro">Passagem (Metrô)</option>
              <option value="uber_taxi">Uber/Taxi</option>
              <option value="outros">Outros</option>
            </select>
          </div>
          <div>
            <label>Valor (R$)</label>
            <input id="expenseAmount" type="number" step="0.01" min="0" placeholder="0,00" required/>
          </div>
        </div>
        <label>Observação</label>
        <input id="expenseNote" type="text" placeholder="Trecho, motivo, etc."/>
        <label>Comprovante (foto)</label>
        <input id="expenseFile" type="file" accept="image/*"/>
        <div class="sep"></div>
        <button class="btn" type="submit">Enviar para aprovação</button>
      </form>
    </div>

    <div class="card" style="padding:16px;">
      <div class="header"><h1>Foto/Vídeo do serviço</h1></div>
      <form id="mediaForm">
        <label>Descrição</label>
        <input id="mediaDesc" type="text" placeholder="Ex.: instalação concluída, antes/depois, etc."/>
        <label>Arquivo</label>
        <input id="mediaFile" type="file" accept="image/*,video/*" required/>
        <div class="sep"></div>
        <button class="btn" type="submit">Enviar mídia</button>
      </form>
      <div class="sep"></div>
      <small class="muted">Arquivos ficam visíveis no painel do administrador.</small>
    </div>
  </div>
</div>

<!-- ============ ADMIN ============ -->
<div id="admin" class="container" style="display:none">
  <div class="headerBar card">
    <div class="brand"><span class="chip">Admin</span><b id="helloAdmin">Olá</b></div>
    <div class="right">
      <button id="btnLogout" class="btn danger" onclick="null">Sair</button>
    </div>
  </div>

  <div class="grid grid-2">
    <div class="card" style="padding:16px;">
      <div class="header"><h1>Funcionários no mapa</h1></div>
      <div id="adminMap"></div>
      <div class="sep"></div>
      <small class="muted">Marcadores representam a última posição reportada por cada funcionário ativo.</small>
    </div>

    <div class="card" style="padding:16px;">
      <div class="header"><h1>Despesas pendentes</h1></div>
      <table class="table">
        <thead><tr>
          <th>Funcionário</th><th>Tipo</th><th>Valor</th><th>Obs</th><th>Comprovante</th><th>Ações</th>
        </tr></thead>
        <tbody id="tbodyExpenses"></tbody>
      </table>
      <div class="sep"></div>
      <div class="header">
        <div><b>Total pendente:</b> <span id="pendingSum">R$ 0,00</span></div>
        <small class="muted">Aprovar move a despesa para status <code>approved</code>; reprovar para <code>rejected</code>.</small>
      </div>
    </div>

    <div class="card" style="padding:16px;">
      <div class="header"><h1>Mídias recentes</h1></div>
      <div id="mediaGrid" class="mediaGrid"></div>
    </div>
  </div>
</div>

</body>
</html>