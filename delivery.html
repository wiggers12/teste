<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Planilha Inteligente - Prot√≥tipo Premium</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-family:'Poppins',sans-serif; background:#0f0f0f; color:#fff; margin:0; }
    header { background:linear-gradient(90deg,#6a1b9a,#8e24aa,#d81b60); padding:20px; text-align:center; font-size:22px; font-weight:600; }
    main { max-width:1300px; margin:auto; padding:20px; }
    .sheet { background:#1e1e2f; padding:20px; border-radius:12px; box-shadow:0 4px 10px rgba(0,0,0,.4); overflow-x:auto; }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th, td { border:1px solid #444; padding:8px; text-align:center; }
    th { background:#2c2c3c; }
    input.cell { background:transparent; border:none; color:#fff; text-align:center; width:100%; }
    .controls { margin:15px 0; display:flex; gap:10px; flex-wrap:wrap; }
    input, button { padding:10px; border-radius:6px; border:none; font-size:14px; }
    input { flex:1; }
    button { background:#8e24aa; color:#fff; cursor:pointer; }
    button:hover { background:#d81b60; }
    .dashboards { display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-top:20px; }
    canvas { background:#121212; border-radius:12px; padding:10px; }
  </style>
</head>
<body>
  <header>üìä Planilha Inteligente - Prot√≥tipo Premium</header>
  <main>
    <div class="controls">
      <input type="text" id="novaColuna" placeholder="Digite o nome da categoria (ex: Receita)">
      <button onclick="adicionarColuna()">‚ûï Adicionar Coluna</button>
      <button onclick="exportarCSV()">‚¨áÔ∏è Exportar CSV</button>
      <button onclick="exportarPDF()">üìÑ Exportar PDF</button>
    </div>

    <!-- Planilha -->
    <div class="sheet">
      <table id="tabela">
        <thead>
          <tr id="cabecalho">
            <th>üìÖ M√™s</th>
          </tr>
        </thead>
        <tbody id="corpo">
          <tr><td>Janeiro</td></tr>
          <tr><td>Fevereiro</td></tr>
          <tr><td>Mar√ßo</td></tr>
          <tr><td>Abril</td></tr>
          <tr><td>Maio</td></tr>
        </tbody>
      </table>
    </div>

    <!-- Dashboards -->
    <div class="dashboards">
      <canvas id="graficoLinha" height="200"></canvas>
      <canvas id="graficoBarra" height="200"></canvas>
      <canvas id="graficoPizza" height="200"></canvas>
    </div>
  </main>

  <script>
    let categorias = [];
    const cabecalho = document.getElementById("cabecalho");
    const corpo = document.getElementById("corpo");

    // --- √çcones por categoria ---
    const icones = {
      receita: "üí∞",
      despesa: "üí∏",
      lucro: "üìà",
      estoque: "üì¶",
      vendas: "üõí",
      marketing: "üì±",
      cliente: "üë•",
      padr√£o: "üìä"
    };

    // --- Gr√°ficos ---
    const ctxLinha = document.getElementById("graficoLinha").getContext("2d");
    const ctxBarra = document.getElementById("graficoBarra").getContext("2d");
    const ctxPizza = document.getElementById("graficoPizza").getContext("2d");

    let graficoLinha = new Chart(ctxLinha, { type:'line', data:{labels:["Janeiro","Fevereiro","Mar√ßo","Abril","Maio"], datasets:[]}, options:{plugins:{legend:{labels:{color:"white"}}}, scales:{x:{ticks:{color:"white"}}, y:{ticks:{color:"white"}}}}});
    let graficoBarra = new Chart(ctxBarra, { type:'bar', data:{labels:["Janeiro","Fevereiro","Mar√ßo","Abril","Maio"], datasets:[]}, options:{plugins:{legend:{labels:{color:"white"}}}, scales:{x:{ticks:{color:"white"}}, y:{ticks:{color:"white"}}}}});
    let graficoPizza = new Chart(ctxPizza, { type:'pie', data:{labels:[], datasets:[{data:[], backgroundColor:[]}]}, options:{plugins:{legend:{labels:{color:"white"}}}}});

    function adicionarColuna(){
      let nome = document.getElementById("novaColuna").value.trim();
      if(!nome) return alert("Digite um nome v√°lido!");
      if(categorias.includes(nome)) return alert("Essa categoria j√° existe!");

      categorias.push(nome);

      // Detecta √≠cone
      const chave = nome.toLowerCase();
      const icone = icones[chave] || icones["padr√£o"];

      // Cabe√ßalho com √≠cone
      const th = document.createElement("th");
      th.innerText = `${icone} ${nome}`;
      cabecalho.appendChild(th);

      // C√©lulas edit√°veis
      for(let i=0; i<corpo.rows.length; i++){
        const td = document.createElement("td");
        const input = document.createElement("input");
        input.type = "number";
        input.className = "cell";
        input.dataset.coluna = nome;
        input.addEventListener("input", atualizarGraficos);
        td.appendChild(input);
        corpo.rows[i].appendChild(td);
      }

      // Adiciona dataset nos gr√°ficos
      const cor = getCor();
      graficoLinha.data.datasets.push({ label:`${icone} ${nome}`, data:Array(corpo.rows.length).fill(0), borderColor:cor, backgroundColor:"transparent" });
      graficoBarra.data.datasets.push({ label:`${icone} ${nome}`, data:Array(corpo.rows.length).fill(0), backgroundColor:cor });
      graficoPizza.data.labels.push(`${icone} ${nome}`);
      graficoPizza.data.datasets[0].data.push(0);
      graficoPizza.data.datasets[0].backgroundColor.push(cor);

      atualizarGraficos();
      document.getElementById("novaColuna").value = "";
    }

    function atualizarGraficos(){
      categorias.forEach((cat, idx)=>{
        let valores = [];
        for(let i=0; i<corpo.rows.length; i++){
          const input = corpo.rows[i].querySelector(`input[data-coluna='${cat}']`);
          valores.push(parseFloat(input.value) || 0);
        }
        graficoLinha.data.datasets[idx].data = valores;
        graficoBarra.data.datasets[idx].data = valores;
        graficoPizza.data.datasets[0].data[idx] = valores.reduce((a,b)=>a+b,0);
      });
      graficoLinha.update();
      graficoBarra.update();
      graficoPizza.update();
    }

    function getCor(){
      const cores = ["#8e24aa","#d81b60","#ffb74d","#29b6f6","#43a047","#f44336","#3f51b5"];
      return cores[(graficoLinha.data.datasets.length) % cores.length];
    }

    // Exportar CSV
    function exportarCSV(){
      let csv = "M√™s,"+categorias.join(",")+"\n";
      for(let i=0; i<corpo.rows.length; i++){
        let linha = corpo.rows[i].cells[0].innerText;
        categorias.forEach(cat=>{
          const input = corpo.rows[i].querySelector(`input[data-coluna='${cat}']`);
          linha += ","+(parseFloat(input.value)||0);
        });
        csv += linha+"\n";
      }
      const blob = new Blob([csv], {type:"text/csv"});
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "planilha_inteligente.csv";
      link.click();
    }

    // Exportar PDF
    async function exportarPDF(){
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(16);
      doc.text("üìä Relat√≥rio - Planilha Inteligente", 20, 20);

      let y = 40;
      for(let i=0; i<corpo.rows.length; i++){
        let linha = corpo.rows[i].cells[0].innerText;
        categorias.forEach(cat=>{
          const input = corpo.rows[i].querySelector(`input[data-coluna='${cat}']`);
          linha += " | " + (parseFloat(input.value)||0);
        });
        doc.text(linha, 20, y);
        y+=10;
      }

      doc.save("planilha_inteligente.pdf");
    }
  </script>
</body>
</html>