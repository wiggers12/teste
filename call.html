<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>RobÃ´ Aviator â€” Previsor v2</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:#0d1117;color:#e6edf3;margin:0;padding:18px}
  h1{text-align:center;margin:0 0 10px}
  textarea,select{width:100%;padding:10px;border-radius:8px;border:1px solid #30363d;background:#161b22;color:#fff}
  button{padding:10px 16px;border:0;border-radius:8px;background:#238636;color:#fff;font-weight:700;cursor:pointer;margin-top:10px}
  .grid{display:grid;gap:12px;grid-template-columns:1fr;max-width:980px;margin:0 auto}
  .card{background:#161b22;border:1px solid #30363d;border-radius:12px;padding:14px}
  .big{font-size:28px;font-weight:800}
  .muted{color:#8b949e}
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;margin-left:8px}
  .green{background:#2ea043;color:#000}
  .yellow{background:#d29922;color:#000}
  .red{background:#da3633}
  canvas{background:#fff;border-radius:10px}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .kpi{background:#0b0f14;border:1px solid #30363d;border-radius:10px;padding:8px 10px}
</style>
</head>
<body>
  <h1>ðŸ“Š RobÃ´ Aviator â€” Previsor v2</h1>
  <div class="grid">

    <div class="card">
      <p>Cole os resultados (separados por vÃ­rgula). Ex.: <span class="muted">1.10, 1.45, 2.30, 10.00, 1.20</span></p>
      <textarea id="inp" rows="4"></textarea>
      <div class="row">
        <label>Janela: 
          <select id="win">
            <option value="20">Ãºltimas 20</option>
            <option value="30" selected>Ãºltimas 30</option>
            <option value="50">Ãºltimas 50</option>
          </select>
        </label>
        <label>Trim superior (cortar explosÃµes): 
          <select id="trim">
            <option value="0.10">10%</option>
            <option value="0.15" selected>15%</option>
            <option value="0.20">20%</option>
          </select>
        </label>
        <label>Peso da recÃªncia (EW): 
          <select id="decay">
            <option value="0.95">suave</option>
            <option value="0.92" selected>mÃ©dio</option>
            <option value="0.88">forte</option>
          </select>
        </label>
      </div>
      <button onclick="run()">Analisar</button>
    </div>

    <div class="card" id="out">
      <div class="big" id="pred">â€”</div>
      <div class="muted" id="explain">Cole os resultados e clique em Analisar.</div>
      <div class="row" style="margin-top:8px">
        <div class="kpi" id="seq">Seq. baixas: â€”</div>
        <div class="kpi" id="since">Desde Ãºltima >10x: â€”</div>
        <div class="kpi" id="ratio">% >5x: â€”</div>
        <div class="kpi" id="std">Volatilidade: â€”</div>
      </div>
    </div>

    <div class="card">
      <canvas id="ch" height="120"></canvas>
    </div>

  </div>

<script>
function parseVals(){
  const raw = document.getElementById('inp').value;
  return raw.split(',').map(s=>parseFloat(String(s).replace(/[^\d.]/g,'')))
             .filter(v=>!isNaN(v)&&v>0);
}
function lastN(arr,n){ return arr.slice(-n); }
function quantile(arr,q){
  if(arr.length===0) return 0;
  const a=[...arr].sort((x,y)=>x-y);
  const idx = (a.length-1)*q;
  const lo = Math.floor(idx), hi=Math.ceil(idx);
  if(lo===hi) return a[lo];
  return a[lo] + (a[hi]-a[lo])*(idx-lo);
}
function winsorizeTop(arr,qTop){
  const q=quantile(arr, 1-qTop); // ex.: 0.85 p/ trim 15%
  return arr.map(v=>Math.min(v,q));
}
function expWeightedMean(arr, decay){
  // decay in (0,1). Newer points get more weight.
  const n=arr.length;
  let wsum=0, xsum=0;
  for(let i=0;i<n;i++){
    const w = Math.pow(decay, n-1-i);
    wsum += w; xsum += w*arr[i];
  }
  return xsum/wsum;
}
function expWeightedStd(arr, decay){
  const mean = expWeightedMean(arr,decay);
  const n=arr.length;
  let wsum=0, ssum=0;
  for(let i=0;i<n;i++){
    const w = Math.pow(decay, n-1-i);
    wsum += w; ssum += w*Math.pow(arr[i]-mean,2);
  }
  return Math.sqrt(ssum/wsum);
}
function consecutiveLowsEnd(arr, thr=2.0){
  let c=0;
  for(let i=arr.length-1;i>=0;i--){
    if(arr[i]<=thr) c++; else break;
  }
  return c;
}
function sinceLastHigh(arr, thr=10.0){
  for(let i=arr.length-1;i>=0;i--){
    if(arr[i]>thr) return arr.length-1-i;
  }
  return Infinity;
}
function ratioAbove(arr, thr){ return arr.filter(v=>v>thr).length/arr.length; }

let chart;

function run(){
  const vals = parseVals();
  const win = parseInt(document.getElementById('win').value||30);
  const trim = parseFloat(document.getElementById('trim').value||0.15);
  const decay = parseFloat(document.getElementById('decay').value||0.92);

  if(vals.length<5){ alert('Cole pelo menos 5 valores.'); return; }

  const v = lastN(vals, win);
  // --- robustez contra explosÃµes ---
  const vWins = winsorizeTop(v, trim); // corta topo (ex.: 15%)
  // --- baseline com peso de recÃªncia ---
  const base = expWeightedMean(vWins, decay);
  let pred = base;

  // --- features ---
  const consecLow = consecutiveLowsEnd(v, 2.0);
  const sinceHigh = sinceLastHigh(v, 10.0);
  const hi5ratio = ratioAbove(v, 5.0);
  const vol = expWeightedStd(vWins, decay);

  // --- ajustes heurÃ­sticos calibrados ---
  // sequÃªncias baixas empurram a previsÃ£o para cima (atÃ© +1.2)
  pred += 0.18 * Math.min(consecLow, 6);

  // alta recente puxa para baixo; se faz tempo sem alta, leve alta
  if (isFinite(sinceHigh)) {
    if (sinceHigh <= 3) pred -= [0.35,0.25,0.15,0.08][sinceHigh] ?? 0.05;
    if (sinceHigh >= 8) pred += 0.25;
  } else {
    // nunca teve >10x na janela
    pred += 0.10;
  }

  // regime com muitas >5x eleva levemente
  if (hi5ratio > 0.20) pred += 0.15 + 0.5*(hi5ratio-0.20);

  // limitar a faixa Ãºtil
  pred = Math.max(1.10, Math.min(pred, 12.0));

  // --- intervalo de confianÃ§a (80%) a partir da volatilidade ponderada ---
  const icWidth = Math.max(0.4, 0.9*vol); // largura depende da vol
  let lo = Math.max(1.00, pred - icWidth);
  let hi = pred + icWidth;

  // --- confianÃ§a qualitativa ---
  let score = 0;
  if (consecLow>=4) score++;
  if (sinceHigh>=10 || !isFinite(sinceHigh)) score++;
  if (vol<2.2) score++;
  if (sinceHigh<=2) score--;           // alta muito recente reduz confianÃ§a
  if (vol>4.5) score--;
  const conf = (score>=2) ? 'alta' : (score>=0 ? 'mÃ©dia' : 'baixa');
  const confBadge = (score>=2) ? 'green' : (score>=0 ? 'yellow' : 'red');

  // --- saÃ­da principal ---
  const predTxt = `ðŸ“Š PrÃ³xima rodada prevista: ~${pred.toFixed(2)}x ` +
                  `<span class="badge ${confBadge}">ConfianÃ§a: ${conf}</span><br>` +
                  `<span class="muted">IC80%: ${lo.toFixed(2)}x â€“ ${hi.toFixed(2)}x</span>`;
  document.getElementById('pred').innerHTML = predTxt;

  document.getElementById('explain').innerHTML =
    `Base: mÃ©dia ponderada winsorizada = ${base.toFixed(2)}x â€¢ ` +
    `ajustes: seq=${consecLow}, desde_alta=${isFinite(sinceHigh)?sinceHigh:'nenhuma'}, ` +
    `%>5x=${(hi5ratio*100).toFixed(0)}%`;

  document.getElementById('seq').textContent = `Seq. baixas: ${consecLow}`;
  document.getElementById('since').textContent = `Desde Ãºltima >10x: ${isFinite(sinceHigh)?sinceHigh+' rod.':'nenhuma'}`;
  document.getElementById('ratio').textContent = `% >5x: ${(hi5ratio*100).toFixed(0)}%`;
  document.getElementById('std').textContent = `Volatilidade: ${vol.toFixed(2)}`;

  // --- grÃ¡fico ---
  const ctx = document.getElementById('ch').getContext('2d');
  if(chart) chart.destroy();
  chart = new Chart(ctx,{
    type:'line',
    data:{
      labels: v.map((_,i)=>i+1),
      datasets:[
        {label:'HistÃ³rico', data:v, borderColor:'#2ea043', backgroundColor:'rgba(46,160,67,.2)', tension:.3, fill:true,
         pointBackgroundColor: v.map(x=>x>10?'red':'#2ea043'), pointRadius:v.map(x=>x>10?6:3)},
        {label:'MÃ©dia ponderada', data:Array(v.length).fill(base), borderColor:'orange', borderDash:[5,5], pointRadius:0},
        {label:'Prevista', data:Array(v.length-1).fill(null).concat([pred]), borderColor:'#58a6ff', pointRadius:5}
      ]
    },
    options:{plugins:{legend:{labels:{color:'#000'}}}, scales:{x:{ticks:{color:'#000'}},y:{ticks:{color:'#000'}}}}
  });
}
</script>
</body>
</html>